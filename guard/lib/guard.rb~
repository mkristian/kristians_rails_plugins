module Guard
  module ActionController #:nodoc:
    module Base #:nodoc:
      def self.included(base)  
        #base.extend(ClassMethods)
        base.send(:include, InstanceMethods)
      end
      module InstanceMethods #:nodoc:
        
        protected
        
        def guard
          unless ::Guard::Guard.check(params[:controller], params[:action], current_user.roles)
            permission_denied
          end
        end

        def permission_denied
          render :text => "permission denied"
        end
      end
    end
  end

  module ActionView #:nodoc:
    module Base #:nodoc:
      # Inclusion hook to make #current_user and #logged_in?
      # available as ActionView helper methods.
      def self.included(base)
        base.send(:include, InstanceMethods)
      end
      
      module InstanceMethods #:nodoc:
        def allowed(controller, action)
          ::Guard::Guard.check(controller, action, current_user.roles)
        end
      end
    end
  end

  class Guard
    
    @@map = {}

    def self.load(logger = Logger(STDOUT))
      @@logger = logger
      Dir.new("#{RAILS_ROOT}/app/guards").to_a.each do |f|
        if f.match(".rb$")
          require "#{RAILS_ROOT}/app/guards/" + f
        end
      end
    end
    
    def self.initialize(controller, map)
      msg = map.collect{ |k,v| "\n\t#{k} => [#{v.join(',')}]"}
      @@logger.info("#{controller} guard: #{msg}")
      @@map[controller] = map
    end
    
    def self.check(controller, action, roles)
      controller = controller.to_sym
      if (@@map.key? controller)
        action = action.to_sym
        allowed = @@map[controller][action]
        if (allowed.nil?)
          throw GuardException.new("unknow action #{action} for controller #{controller}")
        else
          for role in roles
            role = role.to_sym
            if allowed.member? role
              return true
            end
          end
          return false
        end
      else
        throw GuardException.new("unknow controller #{controller}")
      end
    end
  end

  class GuardException < Exception; end
end

module Erector
  class Widget
    def allowed(controller, action)
      if self.respond_to? :current_user
        Guard::Guard.check(controller, action, current_user.roles)
      else 
        true
      end
    end
  end
end
